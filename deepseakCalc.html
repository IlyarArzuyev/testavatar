<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–°—Ç–∞—Ç—É—Å –∏–ø–æ—Ç–µ–∫–∏</title>
  <!-- Materialize CSS -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
  <style>
    header {
      padding: 10px 0;
      background-color: #2196F3;
      color: #fff;
    }
    .avatar {\n      width: 50px;\n      height: 50px;\n      border-radius: 50%;\n    }
    .container {\n      margin-top: 20px;\n    }
  </style>
</head>
<body>
  <!-- –®–∞–ø–∫–∞ —Å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ–º –∏ –∞–≤–∞—Ç–∞—Ä–∫–æ–π -->
  <header>
    <div class="container">
      <div class="row valign-wrapper">
        <div class="col s6">
          <h5 id="greeting">–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π, –≥–æ—Å—Ç—å!</h5>
        </div>
        <div class="col s6 right-align">
          <img id="tgAvatar" src="" alt="–ê–≤–∞—Ç–∞—Ä" class="avatar">
        </div>
      </div>
    </div>
  </header>

  <main>
    <div class="container">
      <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ª–∏—á–Ω–æ–º –Ω–æ–º–µ—Ä–µ -->
      <div class="row">
        <div class="col s12">
          <p id="chatIdText">–í–∞—à –ª–∏—á–Ω—ã–π –Ω–æ–º–µ—Ä: –Ω–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω! –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –µ–≥–æ –Ω–∏–∂–µ.</p>
          <div class="input-field">\n            <input id="chatIdInput" type="text" value="">\n            <label for="chatIdInput">Telegram ID</label>\n          </div>
        </div>
      </div>
      
      <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –∑–∞–∫–∞–∑–µ -->
      <div class="row">
        <div class="col s12 m8 offset-m2">
          <div class="card">
            <div class="card-content">
              <span class="card-title">–í–∞—à –∑–∞–∫–∞–∑</span>
              <p id="orderInfo">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
            </div>
            <div class="card-action">
              <a id="rateBtn" class="waves-effect waves-light btn">–û—Ü–µ–Ω–∏—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä–∞</a>
            </div>
          </div>
        </div>
      </div>
      
      <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ –¥–ª—è –æ—Ü–µ–Ω–∫–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ -->
      <div class="row" id="ratingSection" style="display: none;">
        <div class="col s12 m8 offset-m2">
          <div class="card blue lighten-4">
            <div class="card-content">
              <span class="card-title">–û—Ü–µ–Ω–∫–∞ –º–µ–Ω–µ–¥–∂–µ—Ä–∞</span>
              <div class="input-field">
                <input id="rating" type="number" min="1" max="5">
                <label for="rating">–í–≤–µ–¥–∏—Ç–µ –æ—Ü–µ–Ω–∫—É –æ—Ç 1 –¥–æ 5</label>
              </div>
            </div>
            <div class="card-action">
              <a id="submitRatingBtn" class="waves-effect waves-light btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ü–µ–Ω–∫—É</a>
            </div>
          </div>
        </div>
      </div>
      
    </div>
  </main>
  
  <!-- Materialize JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  <script>
    // URL‚Äë–∞–¥—Ä–µ—Å–∞ –≤–∞—à–∏—Ö Google Apps Script (–∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Å–≤–æ–∏ —Ä–µ–∞–ª—å–Ω—ã–µ URL)
    const GET_STATUS_URL = 'https://script.google.com/macros/s/YOUR_GET_STATUS_SCRIPT_ID/exec';
    const SEND_RATING_URL = 'https://script.google.com/macros/s/YOUR_SEND_RATING_SCRIPT_ID/exec';
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∑–∞–∫–∞–∑–µ –∏–∑ Google Sheets
    function fetchStatus(chatId) {
      fetch(GET_STATUS_URL + '?chat_id=' + encodeURIComponent(chatId))
        .then(response => response.json())
        .then(data => {
          if (data && data.status) {
            const statusText = `
              üë§ –í—ã: ${data.name || '–Ω–µ —É–∫–∞–∑–∞–Ω–æ'}<br>
              üìå –í–∞—à —Å—Ç–∞—Ç—É—Å: ${data.status}<br>
              ‚û°Ô∏è –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥: ${data.next_step}<br>
              üßê –≠–∫—Å–ø–µ—Ä—Ç: ${data.expert}<br>
              üì± –ù–æ–º–µ—Ä —ç–∫—Å–ø–µ—Ä—Ç–∞: ${data.expert_phone}
            `;
            document.getElementById('orderInfo').innerHTML = statusText;
          } else {
            M.toast({html: '–î–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –í–æ–∑–º–æ–∂–Ω–æ, —Å–Ω–∞—á–∞–ª–∞ –Ω–∞–∂–º–∏—Ç–µ /start –≤ Telegram –±–æ—Ç–µ.', classes: 'red'});
            document.getElementById('orderInfo').innerText = '–ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω';
          }
        })
        .catch(error => {
          console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö:', error);
          M.toast({html: '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö', classes: 'red'});
          document.getElementById('orderInfo').innerText = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–∞';
        });
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ü–µ–Ω–∫–∏ –º–µ–Ω–µ–¥–∂–µ—Ä—É
    function sendRating(rating, chatId) {
      fetch(SEND_RATING_URL, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ chat_id: chatId, rating: rating })
      })
      .then(response => response.json())
      .then(data => {
        M.toast({html: '–û—Ü–µ–Ω–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!', classes: 'green'});
        document.getElementById('ratingSection').style.display = 'none';
      })
      .catch(error => {
        console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ü–µ–Ω–∫–∏:', error);
        M.toast({html: '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ü–µ–Ω–∫–∏', classes: 'red'});
      });
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
    document.addEventListener('DOMContentLoaded', function() {
      M.AutoInit();
      
      // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Telegram Web App
      let tgUser = null;
      if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initDataUnsafe) {
        tgUser = window.Telegram.WebApp.initDataUnsafe.user;
      }
      
      // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –¥–æ—Å—Ç—É–ø–Ω—ã, –∑–∞–ø–æ–ª–Ω—è–µ–º —à–∞–ø–∫—É –∏ –ø–æ–ª–µ —Å Telegram ID
      if (tgUser) {
        const username = tgUser.username || tgUser.first_name || '–ì–æ—Å—Ç—å';
        document.getElementById('greeting').innerText = `–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π, ${username}`;
        if(tgUser.photo_url) {
          document.getElementById('tgAvatar').src = tgUser.photo_url;
        } else {
          document.getElementById('tgAvatar').src = 'https://via.placeholder.com/50';
        }
        document.getElementById('chatIdInput').value = tgUser.id;
        document.getElementById('chatIdText').innerText = `–í–∞—à –ª–∏—á–Ω—ã–π –Ω–æ–º–µ—Ä: ${tgUser.id}! –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –µ–≥–æ –Ω–∏–∂–µ.`;
      } else {
        // –ï—Å–ª–∏ –∑–∞–ø—É—â–µ–Ω–æ –≤–Ω–µ Telegram, –º–æ–∂–Ω–æ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –≤–≤–µ—Å—Ç–∏ Telegram ID –≤—Ä—É—á–Ω—É—é
        M.toast({html: '–ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö.', classes: 'orange'});
      }
      
      // –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–æ–ª—è Telegram ID –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç
      document.getElementById('chatIdInput').addEventListener('input', function() {
        const chatId = this.value.trim();
        document.getElementById('chatIdText').innerText = `–í–∞—à –ª–∏—á–Ω—ã–π –Ω–æ–º–µ—Ä: ${chatId}! –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –µ–≥–æ –Ω–∏–∂–µ.`;
      });
      
      // –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã, –µ—Å–ª–∏ chat_id –æ–ø—Ä–µ–¥–µ–ª—ë–Ω
      const currentChatId = document.getElementById('chatIdInput').value.trim();
      if (currentChatId) {
        fetchStatus(currentChatId);
      }
      
      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–û—Ü–µ–Ω–∏—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä–∞"
      document.getElementById('rateBtn').addEventListener('click', function() {
        document.getElementById('ratingSection').style.display = 'block';
      });
      
      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ü–µ–Ω–∫–∏
      document.getElementById('submitRatingBtn').addEventListener('click', function() {
        const rating = document.getElementById('rating').value;
        const chatId = document.getElementById('chatIdInput').value.trim();
        if (rating >= 1 && rating <= 5) {
          sendRating(rating, chatId);
        } else {
          M.toast({html: '–í–≤–µ–¥–∏—Ç–µ –æ—Ü–µ–Ω–∫—É –æ—Ç 1 –¥–æ 5', classes: 'red'});
        }
      });
    });
  </script>
</body>
</html>
